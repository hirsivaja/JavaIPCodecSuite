package com.github.hirsivaja.ip.packet.payload

import com.github.hirsivaja.ip.packet.IpPacket
import com.github.hirsivaja.ip.packet.payload.tcp.TcpHeader
import com.github.hirsivaja.ip.packet.payload.tcp.TcpSegment
import kotlin.test.Test

class TcpSegmentTest {

    @Test
    fun ipv4TcpSegmentTest() {
        val packetString = "4500031F1D2540008006C8C5C0A8C887C0A8C8151EC407D06AF09F2E6F9B26E0501804027C66000020496E7465726E6574205374616E64617264732070726F63657373206D7573742062650A202020666F6C6C6F7765642C206F7220617320726571756972656420746F207472616E736C61746520697420696E746F206C616E677561676573206F74686572207468616E0A202020456E676C6973682E0A0A202020546865206C696D69746564207065726D697373696F6E73206772616E7465642061626F7665206172652070657270657475616C20616E642077696C6C206E6F742062650A2020207265766F6B65642062792074686520496E7465726E657420536F6369657479206F722069747320737563636573736F7273206F722061737369676E732E0A0A2020205468697320646F63756D656E7420616E642074686520696E666F726D6174696F6E20636F6E7461696E65642068657265696E2069732070726F7669646564206F6E20616E0A2020202241532049532220626173697320616E642054484520494E5445524E455420534F434945545920414E442054484520494E5445524E455420454E47494E454552494E470A2020205441534B20464F52434520444953434C41494D5320414C4C2057415252414E544945532C2045585052455353204F5220494D504C4945442C20494E434C5544494E470A202020425554204E4F54204C494D4954454420544F20414E592057415252414E545920544841542054484520555345204F462054484520494E464F524D4154494F4E0A20202048455245494E2057494C4C204E4F5420494E4652494E474520414E5920524947485453204F5220414E5920494D504C4945442057415252414E54494553204F460A2020204D45524348414E544142494C495459204F52204649544E45535320464F52204120504152544943554C415220505552504F53452E0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A576169747A6D616E202020202020202020202020202020202020202020204578706572696D656E74616C202020202020202020202020202020202020202020205B5061676520365D0A0C0A"
        val packet: IpPacket = IpPacket.fromByteString(packetString)
        val encodedString = packet.toByteString()

        val segment: TcpSegment = packet.payload as TcpSegment
        val tcpHeader: TcpHeader = segment.tcpHeader
        assert(7876.toUShort() == tcpHeader.srcPort)
        assert(2000.toUShort() == tcpHeader.dstPort)
        assert(0x6AF09F2E.toUInt() == tcpHeader.sequenceNumber)
        assert(0x6F9B26E0.toUInt() == tcpHeader.ackNumber)
        assert(0x18.toByte() == tcpHeader.flags)
        assert(0x0402.toUShort() == tcpHeader.windowSize)
        assert(0x7C66.toShort() == tcpHeader.checksum)
        assert(0x0000.toUShort() == tcpHeader.urgentPointer)
        assert(759 == segment.data.length())

        assert(packetString == encodedString)
    }

    @Test
    fun ipv6TcpSegmentTest() {
        val packetString = "6000000000B306402A0202E003FE10017777772E00020085200104701F0B16B0022170FFFEB20E6C01BB83B44DA74293E61E843580180032139C00000101080A44DD0F15F6BE2B7A160303005B020000570303CEB1271342B1BF50F47F1C99D09AEF24173EB67E953AD12EA8629F589D320508203A507CAB0E14710F23199E32775D18963EBBA15BC1B6DCC98EB21F9D46ED68A7C03000000FFF01000100000B00020100001700001403030001011603030028FA094B0B19CD12870863082A5912E4D2C38FE1980D798055EAE785C3CEC6F1CDD478752DB6AE47DF"
        val packet: IpPacket = IpPacket.fromByteString(packetString)
        val encodedString = packet.toByteString()

        val segment: TcpSegment = packet.payload as TcpSegment
        val tcpHeader: TcpHeader = segment.tcpHeader
        assert(443.toUShort() == tcpHeader.srcPort)
        assert(33716.toUShort() == tcpHeader.dstPort)
        assert(1302807187u == tcpHeader.sequenceNumber)
        assert(3860759605u == tcpHeader.ackNumber)
        assert(0x18.toByte() == tcpHeader.flags)
        assert(50.toUShort() == tcpHeader.windowSize)
        assert(0x139C.toShort() == tcpHeader.checksum)
        assert(0x0000.toUShort() == tcpHeader.urgentPointer)
        assert(147 == segment.data.length())

        assert(packetString == encodedString)
    }
}
